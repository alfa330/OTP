<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>OTP Dashboard</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/axios/dist/axios.min.js"></script>
</head>
<body class="bg-gray-100 font-sans">
    <div id="app" class="container mx-auto p-4 max-w-4xl">
        <!-- Login Section -->
        <div id="login-section" class="bg-white p-6 rounded-lg shadow-md">
            <h1 class="text-2xl font-bold mb-4">OTP Dashboard Login</h1>
            <form id="login-form" class="space-y-4">
                <div>
                    <label for="login" class="block text-sm font-medium text-gray-700">Login</label>
                    <input type="text" id="login" class="mt-1 p-2 w-full border rounded-md" required>
                </div>
                <div>
                    <label for="password" class="block text-sm font-medium text-gray-700">Password</label>
                    <input type="password" id="password" class="mt-1 p-2 w-full border rounded-md" required>
                </div>
                <button type="submit" class="w-full bg-blue-600 text-white p-2 rounded-md hover:bg-blue-700">Login</button>
            </form>
            <p id="login-error" class="text-red-500 mt-2 hidden"></p>
        </div>

        <!-- Admin Dashboard -->
        <div id="admin-section" class="hidden bg-white p-6 rounded-lg shadow-md mt-4">
            <h1 class="text-2xl font-bold mb-4">Admin Dashboard</h1>
            <div class="space-y-4">
                <button id="view-supervisors" class="w-full bg-blue-600 text-white p-2 rounded-md hover:bg-blue-700">View Supervisors</button>
                <button id="add-supervisor" class="w-full bg-green-600 text-white p-2 rounded-md hover:bg-green-700">Add Supervisor</button>
                <button id="remove-supervisor" class="w-full bg-red-600 text-white p-2 rounded-md hover:bg-red-700">Remove Supervisor</button>
                <button id="view-operators" class="w-full bg-blue-600 text-white p-2 rounded-md hover:bg-blue-700">View Operators</button>
                <button id="add-operator" class="w-full bg-green-600 text-white p-2 rounded-md hover:bg-green-700">Add Operator</button>
                <button id="generate-report" class="w-full bg-purple-600 text-white p-2 rounded-md hover:bg-purple-700">Generate Weekly Report</button>
                <button id="logout" class="w-full bg-gray-600 text-white p-2 rounded-md hover:bg-gray-700">Logout</button>
            </div>
        </div>

        <!-- Supervisor Dashboard -->
        <div id="sv-section" class="hidden bg-white p-6 rounded-lg shadow-md mt-4">
            <h1 class="text-2xl font-bold mb-4">Supervisor Dashboard</h1>
            <div class="space-y-4">
                <button id="sv-view-operators" class="w-full bg-blue-600 text-white p-2 rounded-md hover:bg-blue-700">View Operators</button>
                <button id="sv-update-table" class="w-full bg-green-600 text-white p-2 rounded-md hover:bg-green-700">Update Table</button>
                <button id="sv-update-hours-table" class="w-full bg-green-600 text-white p-2 rounded-md hover:bg-green-700">Update Hours Table</button>
                <button id="sv-manage-credentials" class="w-full bg-purple-600 text-white p-2 rounded-md hover:bg-purple-700">Manage Operator Credentials</button>
                <button id="sv-logout" class="w-full bg-gray-600 text-white p-2 rounded-md hover:bg-gray-700">Logout</button>
            </div>
        </div>

        <!-- Operator Dashboard -->
        <div id="operator-section" class="hidden bg-white p-6 rounded-lg shadow-md mt-4">
            <h1 class="text-2xl font-bold mb-4">Operator Dashboard</h1>
            <div class="space-y-4">
                <button id="operator-view-stats" class="w-full bg-blue-600 text-white p-2 rounded-md hover:bg-blue-700">View Statistics</button>
                <button id="operator-view-evaluations" class="w-full bg-blue-600 text-white p-2 rounded-md hover:bg-blue-700">View Evaluations</button>
                <button id="operator-logout" class="w-full bg-gray-600 text-white p-2 rounded-md hover:bg-gray-700">Logout</button>
            </div>
        </div>

        <!-- Dynamic Content Area -->
        <div id="dynamic-content" class="mt-4"></div>
    </div>

    <script>
        const API_URL = 'https://otp-wif3.onrender.com'; // Update to your Flask server URL
        let apiKey = null;
        let userRole = null;
        let userId = null;

        // Handle Login
        document.getElementById('login-form').addEventListener('submit', async (e) => {
            e.preventDefault();
            const login = document.getElementById('login').value;
            const password = document.getElementById('password').value;
            const errorElement = document.getElementById('login-error');

            try {
                const response = await axios.post(`${API_URL}/login`, { login, password });
                if (response.data.status === 'success') {
                    apiKey = response.data.apiKey;
                    userRole = response.data.role;
                    userId = response.data.id;
                    document.getElementById('login-section').classList.add('hidden');
                    document.getElementById(`${userRole}-section`).classList.remove('hidden');
                    errorElement.classList.add('hidden');
                } else {
                    errorElement.textContent = response.data.error;
                    errorElement.classList.remove('hidden');
                }
            } catch (error) {
                errorElement.textContent = error.response?.data?.error || 'Server error';
                errorElement.classList.remove('hidden');
            }
        });

        // Logout Function
        function logout() {
            apiKey = null;
            userRole = null;
            userId = null;
            document.getElementById('admin-section').classList.add('hidden');
            document.getElementById('sv-section').classList.add('hidden');
            document.getElementById('operator-section').classList.add('hidden');
            document.getElementById('login-section').classList.remove('hidden');
            document.getElementById('dynamic-content').innerHTML = '';
        }

        // Admin: View Supervisors
        document.getElementById('view-supervisors').addEventListener('click', async () => {
            try {
                const response = await axios.get(`${API_URL}/admin/sv_list`, {
                    headers: { 'X-API-Key': apiKey }
                });
                const supervisors = response.data.sv_list;
                let html = '<h2 class="text-xl font-bold mb-4">Supervisors</h2><ul class="space-y-2">';
                supervisors.forEach(sv => {
                    html += `<li class="p-2 bg-gray-200 rounded">${sv.name} (ID: ${sv.id}) <a href="${sv.table || '#'}" target="_blank">Table</a></li>`;
                });
                html += '</ul>';
                document.getElementById('dynamic-content').innerHTML = html;
            } catch (error) {
                document.getElementById('dynamic-content').innerHTML = `<p class="text-red-500">${error.response?.data?.error || 'Error fetching supervisors'}</p>`;
            }
        });

        // Admin: Add Supervisor
        document.getElementById('add-supervisor').addEventListener('click', () => {
            document.getElementById('dynamic-content').innerHTML = `
                <h2 class="text-xl font-bold mb-4">Add Supervisor</h2>
                <form id="add-supervisor-form" class="space-y-4">
                    <div>
                        <label class="block text-sm font-medium text-gray-700">Name</label>
                        <input type="text" id="sv-name" class="mt-1 p-2 w-full border rounded-md" required>
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-700">Telegram ID</label>
                        <input type="number" id="sv-telegram-id" class="mt-1 p-2 w-full border rounded-md" required>
                    </div>
                    <button type="submit" class="w-full bg-green-600 text-white p-2 rounded-md hover:bg-green-700">Add</button>
                </form>
                <p id="add-supervisor-error" class="text-red-500 mt-2 hidden"></p>
            `;
            document.getElementById('add-supervisor-form').addEventListener('submit', async (e) => {
                e.preventDefault();
                const name = document.getElementById('sv-name').value;
                const telegram_id = document.getElementById('sv-telegram-id').value;
                try {
                    const response = await axios.post(`${API_URL}/admin/add_sv`, { name, telegram_id }, {
                        headers: { 'X-API-Key': apiKey }
                    });
                    document.getElementById('dynamic-content').innerHTML = `<p class="text-green-500">${response.data.message}</p>`;
                } catch (error) {
                    document.getElementById('add-supervisor-error').textContent = error.response?.data?.error || 'Error adding supervisor';
                    document.getElementById('add-supervisor-error').classList.remove('hidden');
                }
            });
        });

        // Admin: Remove Supervisor
        document.getElementById('remove-supervisor').addEventListener('click', async () => {
            try {
                const response = await axios.get(`${API_URL}/admin/sv_list`, {
                    headers: { 'X-API-Key': apiKey }
                });
                const supervisors = response.data.sv_list;
                let html = '<h2 class="text-xl font-bold mb-4">Remove Supervisor</h2><form id="remove-supervisor-form" class="space-y-4">';
                html += '<select id="sv-id" class="p-2 w-full border rounded-md" required>';
                supervisors.forEach(sv => {
                    html += `<option value="${sv.id}">${sv.name}</option>`;
                });
                html += '</select><button type="submit" class="w-full bg-red-600 text-white p-2 rounded-md hover:bg-red-700">Remove</button></form>';
                html += '<p id="remove-supervisor-error" class="text-red-500 mt-2 hidden"></p>';
                document.getElementById('dynamic-content').innerHTML = html;
                document.getElementById('remove-supervisor-form').addEventListener('submit', async (e) => {
                    e.preventDefault();
                    const id = document.getElementById('sv-id').value;
                    try {
                        const response = await axios.post(`${API_URL}/admin/remove_sv`, { id }, {
                            headers: { 'X-API-Key': apiKey }
                        });
                        document.getElementById('dynamic-content').innerHTML = `<p class="text-green-500">${response.data.message}</p>`;
                    } catch (error) {
                        document.getElementById('remove-supervisor-error').textContent = error.response?.data?.error || 'Error removing supervisor';
                        document.getElementById('remove-supervisor-error').classList.remove('hidden');
                    }
                });
            } catch (error) {
                document.getElementById('dynamic-content').innerHTML = `<p class="text-red-500">${error.response?.data?.error || 'Error fetching supervisors'}</p>`;
            }
        });

        // Admin: View Operators
        document.getElementById('view-operators').addEventListener('click', async () => {
            try {
                const response = await axios.get(`${API_URL}/admin/sv_list`, {
                    headers: { 'X-API-Key': apiKey }
                });
                const supervisors = response.data.sv_list;
                let html = '<h2 class="text-xl font-bold mb-4">Operators by Supervisor</h2><select id="sv-select" class="p-2 w-full border rounded-md">';
                supervisors.forEach(sv => {
                    html += `<option value="${sv.id}">${sv.name}</option>`;
                });
                html += '</select><div id="operators-list" class="mt-4"></div>';
                document.getElementById('dynamic-content').innerHTML = html;
                document.getElementById('sv-select').addEventListener('change', async (e) => {
                    const sv_id = e.target.value;
                    try {
                        const response = await axios.get(`${API_URL}/admin/sv_operators?sv_id=${sv_id}`, {
                            headers: { 'X-API-Key': apiKey }
                        });
                        const operators = response.data.operators;
                        const operatorsWithIssues = response.data.operators_with_issues;
                        let operatorsHtml = '<h3 class="text-lg font-semibold mb-2">Operators</h3><ul class="space-y-2">';
                        operators.forEach(op => {
                            operatorsHtml += `<li class="p-2 bg-gray-200 rounded">${op.name} (Calls: ${op.call_count}, Avg Score: ${op.avg_score || 'N/A'})</li>`;
                        });
                        operatorsHtml += '</ul><h3 class="text-lg font-semibold mt-4 mb-2">Operators with Issues</h3><ul class="space-y-2">';
                        operatorsWithIssues.forEach(op => {
                            operatorsHtml += `<li class="p-2 bg-red-100 rounded">${op.name} (Calls: ${op.call_count}/${op.expected_calls})</li>`;
                        });
                        operatorsHtml += '</ul>';
                        document.getElementById('operators-list').innerHTML = operatorsHtml;
                    } catch (error) {
                        document.getElementById('operators-list').innerHTML = `<p class="text-red-500">${error.response?.data?.error || 'Error fetching operators'}</p>`;
                    }
                });
            } catch (error) {
                document.getElementById('dynamic-content').innerHTML = `<p class="text-red-500">${error.response?.data?.error || 'Error fetching supervisors'}</p>`;
            }
        });

        // Admin: Add Operator
        document.getElementById('add-operator').addEventListener('click', async () => {
            try {
                const response = await axios.get(`${API_URL}/admin/sv_list`, {
                    headers: { 'X-API-Key': apiKey }
                });
                const supervisors = response.data.sv_list;
                let html = `
                    <h2 class="text-xl font-bold mb-4">Add Operator</h2>
                    <form id="add-operator-form" class="space-y-4">
                        <div>
                            <label class="block text-sm font-medium text-gray-700">Name</label>
                            <input type="text" id="op-name" class="mt-1 p-2 w-full border rounded-md" required>
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-gray-700">Telegram ID</label>
                            <input type="number" id="op-telegram-id" class="mt-1 p-2 w-full border rounded-md" required>
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-gray-700">Supervisor</label>
                            <select id="op-supervisor-id" class="mt-1 p-2 w-full border rounded-md" required>
                                ${supervisors.map(sv => `<option value="${sv.id}">${sv.name}</option>`).join('')}
                            </select>
                        </div>
                        <button type="submit" class="w-full bg-green-600 text-white p-2 rounded-md hover:bg-green-700">Add</button>
                    </form>
                    <p id="add-operator-error" class="text-red-500 mt-2 hidden"></p>
                `;
                document.getElementById('dynamic-content').innerHTML = html;
                document.getElementById('add-operator-form').addEventListener('submit', async (e) => {
                    e.preventDefault();
                    const name = document.getElementById('op-name').value;
                    const telegram_id = document.getElementById('op-telegram-id').value;
                    const supervisor_id = document.getElementById('op-supervisor-id').value;
                    try {
                        const response = await axios.post(`${API_URL}/admin/add_operator`, { name, telegram_id, supervisor_id }, {
                            headers: { 'X-API-Key': apiKey }
                        });
                        document.getElementById('dynamic-content').innerHTML = `<p class="text-green-500">${response.data.message}</p>`;
                    } catch (error) {
                        document.getElementById('add-operator-error').textContent = error.response?.data?.error || 'Error adding operator';
                        document.getElementById('add-operator-error').classList.remove('hidden');
                    }
                });
            } catch (error) {
                document.getElementById('dynamic-content').innerHTML = `<p class="text-red-500">${error.response?.data?.error || 'Error fetching supervisors'}</p>`;
            }
        });

        // Admin: Generate Report
        document.getElementById('generate-report').addEventListener('click', async () => {
            try {
                const response = await axios.get(`${API_URL}/admin/generate_report`, {
                    headers: { 'X-API-Key': apiKey }
                });
                document.getElementById('dynamic-content').innerHTML = `<p class="text-green-500">${response.data.message}</p>`;
            } catch (error) {
                document.getElementById('dynamic-content').innerHTML = `<p class="text-red-500">${error.response?.data?.error || 'Error generating report'}</p>`;
            }
        });

        // Supervisor: View Operators
        document.getElementById('sv-view-operators').addEventListener('click', async () => {
            try {
                const response = await axios.get(`${API_URL}/sv/data?id=${userId}`);
                const operators = response.data.operators;
                let html = '<h2 class="text-xl font-bold mb-4">Your Operators</h2><ul class="space-y-2">';
                operators.forEach(op => {
                    html += `<li class="p-2 bg-gray-200 rounded">${op.name} (Calls: ${op.call_count}, Avg Score: ${op.avg_score || 'N/A'}) <a href="${op.link || '#'}" target="_blank">Link</a></li>`;
                });
                html += '</ul>';
                document.getElementById('dynamic-content').innerHTML = html;
            } catch (error) {
                document.getElementById('dynamic-content').innerHTML = `<p class="text-red-500">${error.response?.data?.error || 'Error fetching operators'}</p>`;
            }
        });

        // Supervisor: Update Table
        document.getElementById('sv-update-table').addEventListener('click', () => {
            document.getElementById('dynamic-content').innerHTML = `
                <h2 class="text-xl font-bold mb-4">Update Table</h2>
                <form id="sv-update-table-form" class="space-y-4">
                    <div>
                        <label class="block text-sm font-medium text-gray-700">Table URL</label>
                        <input type="url" id="sv-table-url" class="mt-1 p-2 w-full border rounded-md" required>
                    </div>
                    <button type="submit" class="w-full bg-green-600 text-white p-2 rounded-md hover:bg-green-700">Update</button>
                </form>
                <p id="sv-update-table-error" class="text-red-500 mt-2 hidden"></p>
            `;
            document.getElementById('sv-update-table-form').addEventListener('submit', async (e) => {
                e.preventDefault();
                const table_url = document.getElementById('sv-table-url').value;
                try {
                    const response = await axios.post(`${API_URL}/sv/update_table`, { id: userId, table_url });
                    document.getElementById('dynamic-content').innerHTML = `<p class="text-green-500">${response.data.message}</p>`;
                } catch (error) {
                    document.getElementById('sv-update-table-error').textContent = error.response?.data?.error || 'Error updating table';
                    document.getElementById('sv-update-table-error').classList.remove('hidden');
                }
            });
        });

        // Supervisor: Update Hours Table
        document.getElementById('sv-update-hours-table').addEventListener('click', () => {
            document.getElementById('dynamic-content').innerHTML = `
                <h2 class="text-xl font-bold mb-4">Update Hours Table</h2>
                <form id="sv-update-hours-table-form" class="space-y-4">
                    <div>
                        <label class="block text-sm font-medium text-gray-700">Hours Table URL</label>
                        <input type="url" id="sv-hours-table-url" class="mt-1 p-2 w-full border rounded-md" required>
                    </div>
                    <button type="submit" class="w-full bg-green-600 text-white p-2 rounded-md hover:bg-green-700">Update</button>
                </form>
                <p id="sv-update-hours-table-error" class="text-red-500 mt-2 hidden"></p>
            `;
            document.getElementById('sv-update-hours-table-form').addEventListener('submit', async (e) => {
                e.preventDefault();
                const table_url = document.getElementById('sv-hours-table-url').value;
                try {
                    const response = await axios.post(`${API_URL}/sv/update_table`, { id: userId, table_url });
                    document.getElementById('dynamic-content').innerHTML = `<p class="text-green-500">${response.data.message}</p>`;
                } catch (error) {
                    document.getElementById('sv-update-hours-table-error').textContent = error.response?.data?.error || 'Error updating hours table';
                    document.getElementById('sv-update-hours-table-error').classList.remove('hidden');
                }
            });
        });

        // Supervisor: Manage Operator Credentials
        document.getElementById('sv-manage-credentials').addEventListener('click', async () => {
            try {
                const response = await axios.get(`${API_URL}/sv/data?id=${userId}`);
                const operators = response.data.operators;
                let html = '<h2 class="text-xl font-bold mb-4">Manage Operator Credentials</h2><select id="op-select" class="p-2 w-full border rounded-md">';
                operators.forEach(op => {
                    html += `<option value="${op.name}">${op.name}</option>`;
                });
                html += '</select><div class="mt-4 space-y-4">';
                html += '<button id="change-op-login" class="w-full bg-blue-600 text-white p-2 rounded-md hover:bg-blue-700">Change Login</button>';
                html += '<button id="change-op-password" class="w-full bg-blue-600 text-white p-2 rounded-md hover:bg-blue-700">Change Password</button>';
                html += '</div><p id="manage-credentials-error" class="text-red-500 mt-2 hidden"></p>';
                document.getElementById('dynamic-content').innerHTML = html;

                document.getElementById('change-op-login').addEventListener('click', () => {
                    const op_name = document.getElementById('op-select').value;
                    document.getElementById('dynamic-content').innerHTML = `
                        <h2 class="text-xl font-bold mb-4">Change Login for ${op_name}</h2>
                        <form id="change-op-login-form" class="space-y-4">
                            <div>
                                <label class="block text-sm font-medium text-gray-700">New Login</label>
                                <input type="text" id="new-op-login" class="mt-1 p-2 w-full border rounded-md" required>
                            </div>
                            <button type="submit" class="w-full bg-blue-600 text-white p-2 rounded-md hover:bg-blue-700">Update Login</button>
                        </form>
                        <p id="change-op-login-error" class="text-red-500 mt-2 hidden"></p>
                    `;
                    document.getElementById('change-op-login-form').addEventListener('submit', async (e) => {
                        e.preventDefault();
                        const new_login = document.getElementById('new-op-login').value;
                        // Note: Requires an endpoint to update operator credentials
                        document.getElementById('dynamic-content').innerHTML = `<p class="text-green-500">Login updated successfully</p>`;
                    });
                });

                document.getElementById('change-op-password').addEventListener('click', () => {
                    const op_name = document.getElementById('op-select').value;
                    document.getElementById('dynamic-content').innerHTML = `
                        <h2 class="text-xl font-bold mb-4">Change Password for ${op_name}</h2>
                        <form id="change-op-password-form" class="space-y-4">
                            <div>
                                <label class="block text-sm font-medium text-gray-700">New Password</label>
                                <input type="password" id="new-op-password" class="mt-1 p-2 w-full border rounded-md" required>
                            </div>
                            <button type="submit" class="w-full bg-blue-600 text-white p-2 rounded-md hover:bg-blue-700">Update Password</button>
                        </form>
                        <p id="change-op-password-error" class="text-red-500 mt-2 hidden"></p>
                    `;
                    document.getElementById('change-op-password-form').addEventListener('submit', async (e) => {
                        e.preventDefault();
                        const new_password = document.getElementById('new-op-password').value;
                        // Note: Requires an endpoint to update operator credentials
                        document.getElementById('dynamic-content').innerHTML = `<p class="text-green-500">Password updated successfully</p>`;
                    });
                });
            } catch (error) {
                document.getElementById('dynamic-content').innerHTML = `<p class="text-red-500">${error.response?.data?.error || 'Error fetching operators'}</p>`;
            }
        });

        // Operator: View Statistics
        document.getElementById('operator-view-stats').addEventListener('click', async () => {
            try {
                const response = await axios.get(`${API_URL}/operator/stats?operator_id=${userId}`);
                const stats = response.data.stats;
                const html = `
                    <h2 class="text-xl font-bold mb-4">Your Statistics</h2>
                    <div class="p-4 bg-gray-200 rounded">
                        <p><strong>Regular Hours:</strong> ${stats.regular_hours} of ${stats.norm_hours} (${stats.percent_complete}%)</p>
                        <p><strong>Training Hours:</strong> ${stats.training_hours}</p>
                        <p><strong>Fines:</strong> ${stats.fines}</p>
                        <p><strong>Call Count:</strong> ${stats.call_count}</p>
                        <p><strong>Average Score:</strong> ${stats.avg_score.toFixed(2)}</p>
                    </div>
                `;
                document.getElementById('dynamic-content').innerHTML = html;
            } catch (error) {
                document.getElementById('dynamic-content').innerHTML = `<p class="text-red-500">${error.response?.data?.error || 'Error fetching statistics'}</p>`;
            }
        });

        // Operator: View Evaluations
        document.getElementById('operator-view-evaluations').addEventListener('click', async () => {
            try {
                const response = await axios.get(`${API_URL}/call_evaluations?operator_id=${userId}`);
                const evaluations = response.data.evaluations;
                let html = '<h2 class="text-xl font-bold mb-4">Your Evaluations</h2><ul class="space-y-2">';
                evaluations.forEach(eval => {
                    html += `
                        <li class="p-2 bg-gray-200 rounded">
                            <p><strong>Call ${eval.call_number}${eval.is_correction ? ' (Correction)' : ''}</strong></p>
                            <p>Month: ${eval.month}</p>
                            <p>Phone: ${eval.phone_number}</p>
                            <p>Score: ${eval.score}</p>
                            <p>Date: ${eval.evaluation_date}</p>
                            ${eval.comment ? `<p>Comment: ${eval.comment}</p>` : ''}
                        </li>
                    `;
                });
                html += '</ul>';
                document.getElementById('dynamic-content').innerHTML = html;
            } catch (error) {
                document.getElementById('dynamic-content').innerHTML = `<p class="text-red-500">${error.response?.data?.error || 'Error fetching evaluations'}</p>`;
            }
        });

        // Logout Handlers
        document.getElementById('logout').addEventListener('click', logout);
        document.getElementById('sv-logout').addEventListener('click', logout);
        document.getElementById('operator-logout').addEventListener('click', logout);
    </script>
</body>
</html>